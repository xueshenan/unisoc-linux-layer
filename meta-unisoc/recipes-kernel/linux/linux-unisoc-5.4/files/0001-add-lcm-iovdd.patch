From 62f28a33782efc465b91c13b173b4a5a264c15aa Mon Sep 17 00:00:00 2001
From: fujia <fujia@bingtangtech.com>
Date: Tue, 1 Aug 2023 12:36:42 +0800
Subject: [PATCH] add lcm iovdd

---
 drivers/gpu/drm/sprd/qogirn6pro/global_dpu.c |  2 +-
 drivers/gpu/drm/sprd/sprd_dsi_panel.c        | 16 ++++++++++++++++
 drivers/gpu/drm/sprd/sprd_dsi_panel.h        |  1 +
 3 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/sprd/qogirn6pro/global_dpu.c b/drivers/gpu/drm/sprd/qogirn6pro/global_dpu.c
index b43ccce52..445eb9f17 100755
--- a/drivers/gpu/drm/sprd/qogirn6pro/global_dpu.c
+++ b/drivers/gpu/drm/sprd/qogirn6pro/global_dpu.c
@@ -296,7 +296,7 @@ static int dpu_clk_disable(struct dpu_context *ctx)
 	clk_disable_unprepare(clk_ctx->clk_dpu_dpi);
 	clk_disable_unprepare(clk_ctx->clk_dpu_core);
 
-	clk_set_parent(clk_ctx->clk_dpu_dpi, clk_ctx->clk_src_256m);
+	clk_set_parent(clk_ctx->clk_dpu_dpi, clk_ctx->clk_src_307m2);
 	clk_set_parent(clk_ctx->clk_dpu_core, clk_ctx->clk_src_307m2);
 
 	return 0;
diff --git a/drivers/gpu/drm/sprd/sprd_dsi_panel.c b/drivers/gpu/drm/sprd/sprd_dsi_panel.c
index f2652478d..2621462ef 100644
--- a/drivers/gpu/drm/sprd/sprd_dsi_panel.c
+++ b/drivers/gpu/drm/sprd/sprd_dsi_panel.c
@@ -86,6 +86,11 @@ static int sprd_panel_unprepare(struct drm_panel *p)
 		mdelay(5);
 	}
 
+	if (panel->info.iovdd_gpio) {
+		gpiod_direction_output(panel->info.iovdd_gpio, 0);
+		mdelay(5);
+	}
+
 	regulator_disable(panel->supply);
 
 	return 0;
@@ -103,6 +108,11 @@ static int sprd_panel_prepare(struct drm_panel *p)
 	if (ret < 0)
 		DRM_ERROR("enable lcd regulator failed\n");
 
+	if (panel->info.iovdd_gpio) {
+		gpiod_direction_output(panel->info.iovdd_gpio, 1);
+		mdelay(5);
+	}
+
 	if (panel->info.avdd_gpio) {
 		gpiod_direction_output(panel->info.avdd_gpio, 1);
 		mdelay(5);
@@ -477,6 +487,12 @@ static void sprd_panel_esd_work_func(struct work_struct *work)
 static int sprd_panel_gpio_request(struct device *dev,
 			struct sprd_panel *panel)
 {
+	panel->info.iovdd_gpio = devm_gpiod_get_optional(dev,
+					"iovdd", GPIOD_ASIS);
+	if (IS_ERR_OR_NULL(panel->info.iovdd_gpio))
+		DRM_WARN("can't get panel iovdd gpio: %ld\n",
+				 PTR_ERR(panel->info.iovdd_gpio));
+
 	panel->info.avdd_gpio = devm_gpiod_get_optional(dev,
 					"avdd", GPIOD_ASIS);
 	if (IS_ERR_OR_NULL(panel->info.avdd_gpio))
diff --git a/drivers/gpu/drm/sprd/sprd_dsi_panel.h b/drivers/gpu/drm/sprd/sprd_dsi_panel.h
index 62f867941..745d73dec 100644
--- a/drivers/gpu/drm/sprd/sprd_dsi_panel.h
+++ b/drivers/gpu/drm/sprd/sprd_dsi_panel.h
@@ -72,6 +72,7 @@ struct panel_info {
 	struct gpio_desc *avdd_gpio;
 	struct gpio_desc *avee_gpio;
 	struct gpio_desc *reset_gpio;
+	struct gpio_desc *iovdd_gpio;
 	struct reset_sequence rst_on_seq;
 	struct reset_sequence rst_off_seq;
 	const void *cmds[CMD_CODE_MAX];
-- 
2.25.1

